name: TRACT EVENT Runner

on:
  schedule:
    - cron: '0 * * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# å¹¶å‘æŽ§åˆ¶ï¼šé¿å…é‡å¤æ‰§è¡Œ
concurrency:
  group: track-event-runner
  cancel-in-progress: false # å…è®¸æŽ’é˜Ÿç­‰å¾…

jobs:
  run-test:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # =======================================================
      # ðŸ‘‡ ä¿®æ”¹åŽçš„éªŒè¯æ­¥éª¤ (éžé˜»å¡žå¼ï¼Œä¸­æ–‡æ—¥å¿—) ðŸ‘‡
      # =======================================================
      - name: Verify Gitee Accessibility
        id: gitee-check # ç»™è¿™ä¸ªæ­¥éª¤ä¸€ä¸ªIDï¼Œæ–¹ä¾¿åŽç»­æ­¥éª¤å¼•ç”¨å®ƒçš„è¾“å‡º
        run: |
          echo "ðŸ” æ­£åœ¨éªŒè¯å½“å‰ Runner å¯¹ Gitee çš„è®¿é—®èƒ½åŠ›..."
          
          # é»˜è®¤è®¾ç½®ä¸ºä¸å¯è®¿é—®
          GITEE_ACCESSIBLE="false"
          
          HTTP_STATUS=$(curl -s -o /dev/null -I -w "%{http_code}" --connect-timeout 10 -m 15 https://gitee.com)
          
          # æ£€æŸ¥ curl å‘½ä»¤æœ¬èº«æ˜¯å¦æˆåŠŸ
          if [ $? -eq 0 ] && [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… éªŒè¯æˆåŠŸï¼Gitee å¯æ­£å¸¸è®¿é—® (HTTP 200)ã€‚"
            GITEE_ACCESSIBLE="true"
          else
            echo "âš ï¸ è­¦å‘Šï¼šæ— æ³•è®¿é—® Giteeã€‚"
            if [ $? -ne 0 ]; then
              echo "âš ï¸ åŽŸå› ï¼šcurl å‘½ä»¤è¶…æ—¶æˆ–é‡åˆ°ç½‘ç»œé”™è¯¯ã€‚"
            else
              echo "âš ï¸ åŽŸå› ï¼šGitee è¿”å›žçš„ HTTP çŠ¶æ€ç ä¸º: $HTTP_STATUS"
            fi
            echo "âš ï¸ åŽç»­éœ€è¦è®¿é—® Gitee çš„æ­¥éª¤å°†è¢«è·³è¿‡ã€‚"
          fi
          
          # å°†ç»“æžœè®¾ç½®ä¸ºçŽ¯å¢ƒå˜é‡ï¼Œå¹¶è¾“å‡ºåˆ°åŽç»­æ­¥éª¤
          echo "GITEE_ACCESSIBLE=$GITEE_ACCESSIBLE" >> $GITHUB_ENV
      # =======================================================

      - name: Run test script
        env:
          API_T: ${{ secrets.API_T }}
          API_D: ${{ secrets.API_D }}
          GITEE_TRAIN_LIST_URL: ${{ secrets.GITEE_TRAIN_LIST_URL }}
          GITEE_MINI_DATA_UPLOADER_URL: ${{ secrets.GITEE_MINI_DATA_UPLOADER_URL }}
          GITEE_MINI_DATA_DOWNLOADER_URL: ${{ secrets.GITEE_MINI_DATA_DOWNLOADER_URL }}
          GITEE_MINI_DATABASE_URL: ${{ secrets.GITEE_MINI_DATABASE_URL }}

          MY_GITHUB_TRAIN_LIST_URL: ${{ secrets.MY_GITHUB_TRAIN_LIST_URL }}
          MY_GITHUB_MINI_DATA_UPLOADER_URL: ${{ secrets.MY_GITHUB_MINI_DATA_UPLOADER_URL }}
          MY_GITHUB_MINI_DATA_DOWNLOADER_URL: ${{ secrets.MY_GITHUB_MINI_DATA_DOWNLOADER_URL }}
          MY_GITHUB_MINI_DATABASE_URL: ${{ secrets.MY_GITHUB_MINI_DATABASE_URL }}
        run: npx tsx scripts/processTrackEvents.ts

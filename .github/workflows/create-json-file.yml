name: Daily Test Runner

on:
  schedule:
    # 每天16点15分UTC运行（北京时间0点15分）
    - cron: '15 16 * * *'
  # 允许手动触发
  workflow_dispatch:

jobs:
  run-test:
    runs-on: ubuntu-latest
    
    # 添加权限设置
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 添加token以允许推送更改
          token: ${{ secrets.GITHUB_TOKEN }}
          # 获取所有历史记录以便打tag
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run test script
        env:
          API_T: ${{ secrets.API_T }}
          API_D: ${{ secrets.API_D }}
        run: npx tsx scripts/process.ts

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # 设置时区为北京时间
          export TZ="Asia/Shanghai"
          # 获取北京时区的日期
          BEIJING_DATE=$(date '+%Y-%m-%d')
          # 添加所有变化
          git add data/
          # 检查是否有变化
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update data directory for $BEIJING_DATE"
            git push
          
            # 获取当天已有的tag数量
            EXISTING_TAGS=$(git tag -l "$BEIJING_DATE-*" | wc -l)
            # 计算新tag的序号（现有数量+1）
            TAG_NUMBER=$((EXISTING_TAGS + 1))
            # 创建新tag
            NEW_TAG="$BEIJING_DATE-$TAG_NUMBER"
            git tag -a "$NEW_TAG" -m "Daily update for $BEIJING_DATE (#$TAG_NUMBER)"
            git push origin "$NEW_TAG"
            echo "Created tag: $NEW_TAG"
          fi

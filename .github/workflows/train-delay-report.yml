name: TRAIN DELAY Runner

on:
  schedule:
    # æ¯å¤©16ç‚¹15åˆ†UTCè¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´0ç‚¹15åˆ†ï¼‰ï¼Œå‡Œæ™¨æ‰§è¡Œä¸€æ¬¡ï¼Œç”¨äºå¤‡ä»½å†å²æ™šç‚¹ä¿¡æ¯ã€‚ä½¿å¾—ä»Šå¤©çš„æ™šç‚¹ä¿¡æ¯åˆ—è¡¨æ˜¯é‡ç½®çš„
    - cron: '15 16 * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # é€šè¿‡ repository_dispatch äº‹ä»¶æ¥æ”¶ Gitee çš„è§¦å‘
  repository_dispatch:
    types: [ train-delay-report ]

# å¹¶å‘æ§åˆ¶ï¼šé¿å…é‡å¤æ‰§è¡Œ
concurrency:
  group: train-delay-runner
  cancel-in-progress: false # å…è®¸æ’é˜Ÿç­‰å¾…

jobs:
  run-test:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # =======================================================
      # ğŸ‘‡ æ–°å¢çš„éªŒè¯æ­¥éª¤ (å¸¦è¶…æ—¶) ğŸ‘‡
      # =======================================================
      - name: Verify Gitee Accessibility
        run: |
          echo "ğŸ” Verifying Gitee accessibility from the runner..."
          
          # è®¾ç½®è¶…æ—¶å‚æ•°
          # --connect-timeout 10: 10ç§’å†…å¿…é¡»è¿æ¥æˆåŠŸ
          # -m 15: æ•´ä¸ªè¯·æ±‚åœ¨15ç§’å†…å¿…é¡»å®Œæˆ
          # -s: é™é»˜æ¨¡å¼
          # -o /dev/null: ä¸¢å¼ƒå“åº”ä½“
          # -I: åªè·å–å¤´éƒ¨ä¿¡æ¯
          # -w "%{http_code}": åªè¾“å‡ºHTTPçŠ¶æ€ç 
          HTTP_STATUS=$(curl -s -o /dev/null -I -w "%{http_code}" --connect-timeout 10 -m 15 https://gitee.com)
          
          # æ£€æŸ¥ curl å‘½ä»¤æœ¬èº«æ˜¯å¦å› ä¸ºè¶…æ—¶æˆ–ç½‘ç»œé”™è¯¯è€Œå¤±è´¥ (è¿”å›ç é0)
          if [ $? -ne 0 ]; then
            echo "âŒ Verification failed! curl command timed out or encountered a network error."
            echo "âŒ This runner's IP is likely blocked or cannot reach Gitee reliably."
            exit 1
          fi
          
          # æ£€æŸ¥ HTTP çŠ¶æ€ç 
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "âŒ Verification failed!"
            echo "âŒ Gitee returned HTTP status: $HTTP_STATUS"
            echo "âŒ This runner's IP is likely blocked by Gitee."
            exit 1
          else
            echo "âœ… Verification successful! Gitee is accessible (HTTP 200)."
          fi
      # =======================================================

      - name: Run test script
        env:
          GITEE_TRAIN_LIST_URL: ${{ secrets.GITEE_TRAIN_LIST_URL }}
          GITEE_MINI_DATA_UPLOADER_URL: ${{ secrets.GITEE_MINI_DATA_UPLOADER_URL }}
          GITEE_MINI_DATA_DOWNLOADER_URL: ${{ secrets.GITEE_MINI_DATA_DOWNLOADER_URL }}
          GITEE_MINI_DATABASE_URL: ${{ secrets.GITEE_MINI_DATABASE_URL }}

          MY_GITHUB_TRAIN_LIST_URL: ${{ secrets.MY_GITHUB_TRAIN_LIST_URL }}
          MY_GITHUB_MINI_DATA_UPLOADER_URL: ${{ secrets.MY_GITHUB_MINI_DATA_UPLOADER_URL }}
          MY_GITHUB_MINI_DATA_DOWNLOADER_URL: ${{ secrets.MY_GITHUB_MINI_DATA_DOWNLOADER_URL }}
          MY_GITHUB_MINI_DATABASE_URL: ${{ secrets.MY_GITHUB_MINI_DATABASE_URL }}
        run: npx tsx scripts/processTrainDelayReport.ts
